import type { SimTopology, SimulationConfig } from '@simforge/types';

export interface SimforgeTemplate {
  id: string;
  name: string;
  description: string;
  topology: SimTopology;
  config?: Partial<SimulationConfig>;
}

const DEFAULT_EDGE_CONFIG = {
  latencyMs: { type: 'constant', value: 2 } as const,
  bandwidthMbps: 1000,
  failureRate: 0,
};

export const builtInTemplates: SimforgeTemplate[] = [
  {
    id: 'template-lb-services',
    name: 'Load-Balanced Services',
    description: 'Edge LB distributing traffic to three services.',
    topology: {
      nodes: [
        {
          id: 'client-user',
          config: { kind: 'client' },
          position: { x: 320, y: 0 },
          metadata: { label: 'User' },
        },
        {
          id: 'lb-edge',
          config: {
            kind: 'load-balancer',
            algorithm: 'round-robin',
            maxConnections: 10000,
          },
          position: { x: 320, y: 140 },
          metadata: { label: 'Edge LB' },
        },
        {
          id: 'svc-auth',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'constant', value: 25 },
            failureRate: 0.005,
            maxConcurrency: 200,
          },
          position: { x: 80, y: 320 },
          metadata: { label: 'Auth Service' },
        },
        {
          id: 'svc-api',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'constant', value: 30 },
            failureRate: 0.005,
            maxConcurrency: 200,
          },
          position: { x: 320, y: 320 },
          metadata: { label: 'API Service' },
        },
        {
          id: 'svc-billing',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'constant', value: 35 },
            failureRate: 0.005,
            maxConcurrency: 200,
          },
          position: { x: 560, y: 320 },
          metadata: { label: 'Billing Service' },
        },
      ],
      edges: [
        { id: 'edge-client-lb', source: 'client-user', target: 'lb-edge', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-lb-auth', source: 'lb-edge', target: 'svc-auth', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-lb-api', source: 'lb-edge', target: 'svc-api', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-lb-billing', source: 'lb-edge', target: 'svc-billing', config: DEFAULT_EDGE_CONFIG },
      ],
    },
    config: {
      seed: 42,
      maxTimeMs: 10000,
      requestRateRps: 600,
      requestDistribution: 'constant',
    },
  },
  {
    id: 'template-event-driven',
    name: 'Event-Driven Pipeline',
    description: 'Gateway ingress through queue and async worker into database.',
    topology: {
      nodes: [
        {
          id: 'client-user',
          config: { kind: 'client' },
          position: { x: 120, y: 40 },
          metadata: { label: 'Client' },
        },
        {
          id: 'api-gw',
          config: {
            kind: 'api-gateway',
            rateLimitRps: 2000,
            burstSize: 120,
            authLatencyMs: { type: 'constant', value: 4 },
            routes: 12,
            failureRate: 0.002,
            maxConcurrentRequests: 1500,
          },
          position: { x: 120, y: 180 },
          metadata: { label: 'Public API Gateway' },
        },
        {
          id: 'queue-jobs',
          config: {
            kind: 'queue',
            maxDepth: 5000,
            processingTimeMs: { type: 'constant', value: 8 },
            deadLetterEnabled: true,
          },
          position: { x: 400, y: 180 },
          metadata: { label: 'Jobs Queue' },
        },
        {
          id: 'svc-worker',
          config: {
            kind: 'service',
            replicas: 4,
            latencyMs: { type: 'constant', value: 45 },
            failureRate: 0.01,
            maxConcurrency: 180,
          },
          position: { x: 660, y: 180 },
          metadata: { label: 'Worker Service' },
        },
        {
          id: 'db-events',
          config: {
            kind: 'database',
            engine: 'postgres',
            maxConnections: 240,
            queryLatencyMs: { type: 'normal', mean: 6, stddev: 2 },
            writeLatencyMs: { type: 'normal', mean: 12, stddev: 3 },
            failureRate: 0.001,
            connectionPoolSize: 200,
            replicationFactor: 2,
          },
          position: { x: 920, y: 180 },
          metadata: { label: 'Events DB' },
        },
      ],
      edges: [
        { id: 'edge-client-gw', source: 'client-user', target: 'api-gw', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-gw-queue', source: 'api-gw', target: 'queue-jobs', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-queue-worker', source: 'queue-jobs', target: 'svc-worker', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-worker-db', source: 'svc-worker', target: 'db-events', config: DEFAULT_EDGE_CONFIG },
      ],
    },
    config: {
      seed: 42,
      maxTimeMs: 12000,
      requestRateRps: 350,
      requestDistribution: 'poisson',
    },
  },
  {
    id: 'template-cached-read-api',
    name: 'Cached Read API',
    description: 'API + service with cache fronting a backing database.',
    topology: {
      nodes: [
        {
          id: 'client-user',
          config: { kind: 'client' },
          position: { x: 80, y: 200 },
          metadata: { label: 'Client' },
        },
        {
          id: 'gw-read',
          config: {
            kind: 'api-gateway',
            rateLimitRps: 2500,
            burstSize: 150,
            authLatencyMs: { type: 'constant', value: 2 },
            routes: 20,
            failureRate: 0.001,
            maxConcurrentRequests: 2200,
          },
          position: { x: 280, y: 200 },
          metadata: { label: 'Read API Gateway' },
        },
        {
          id: 'svc-read',
          config: {
            kind: 'service',
            replicas: 3,
            latencyMs: { type: 'constant', value: 18 },
            failureRate: 0.004,
            maxConcurrency: 240,
          },
          position: { x: 520, y: 200 },
          metadata: { label: 'Read Service' },
        },
        {
          id: 'cache-hot',
          config: {
            kind: 'cache',
            evictionPolicy: 'lru',
            maxSizeMb: 512,
            hitRate: 0.9,
            hitLatencyMs: { type: 'constant', value: 1 },
            missLatencyMs: { type: 'constant', value: 3 },
            ttlMs: 120000,
            maxEntries: 250000,
          },
          position: { x: 760, y: 200 },
          metadata: { label: 'Hot Cache' },
        },
        {
          id: 'db-core',
          config: {
            kind: 'database',
            engine: 'postgres',
            maxConnections: 200,
            queryLatencyMs: { type: 'normal', mean: 5, stddev: 2 },
            writeLatencyMs: { type: 'normal', mean: 10, stddev: 3 },
            failureRate: 0.001,
            connectionPoolSize: 160,
            replicationFactor: 2,
          },
          position: { x: 1000, y: 200 },
          metadata: { label: 'Core DB' },
        },
      ],
      edges: [
        { id: 'edge-client-gw', source: 'client-user', target: 'gw-read', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-gw-svc', source: 'gw-read', target: 'svc-read', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-svc-cache', source: 'svc-read', target: 'cache-hot', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-cache-db', source: 'cache-hot', target: 'db-core', config: DEFAULT_EDGE_CONFIG },
      ],
    },
    config: {
      seed: 42,
      maxTimeMs: 10000,
      requestRateRps: 900,
      requestDistribution: 'constant',
    },
  },
  {
    id: 'template-video-upload',
    name: 'Video Upload Pipeline',
    description: 'Upload → transcode → store workflow with async processing.',
    topology: {
      nodes: [
        {
          id: 'client-user',
          config: { kind: 'client' },
          position: { x: 400, y: 0 },
          metadata: { label: 'User' },
        },
        {
          id: 'api-gw',
          config: {
            kind: 'api-gateway',
            rateLimitRps: 500,
            burstSize: 30,
            authLatencyMs: { type: 'constant', value: 3 },
            routes: 8,
            failureRate: 0.003,
            maxConcurrentRequests: 800,
          },
          position: { x: 400, y: 140 },
          metadata: { label: 'API Gateway' },
        },
        {
          id: 'svc-upload',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'normal', mean: 40, stddev: 10 },
            failureRate: 0.008,
            maxConcurrency: 200,
          },
          position: { x: 400, y: 280 },
          metadata: { label: 'Upload Service' },
        },
        {
          id: 'queue-transcode',
          config: {
            kind: 'queue',
            maxDepth: 2000,
            processingTimeMs: { type: 'constant', value: 15 },
            deadLetterEnabled: true,
          },
          position: { x: 400, y: 420 },
          metadata: { label: 'Transcode Queue' },
        },
        {
          id: 'svc-transcode',
          config: {
            kind: 'service',
            replicas: 3,
            latencyMs: { type: 'normal', mean: 200, stddev: 50 },
            failureRate: 0.02,
            maxConcurrency: 50,
          },
          position: { x: 400, y: 560 },
          metadata: { label: 'Transcoding Service' },
        },
        {
          id: 'db-storage',
          config: {
            kind: 'database',
            engine: 'postgres',
            maxConnections: 100,
            queryLatencyMs: { type: 'normal', mean: 8, stddev: 3 },
            writeLatencyMs: { type: 'normal', mean: 15, stddev: 5 },
            failureRate: 0.002,
            connectionPoolSize: 80,
            replicationFactor: 3,
          },
          position: { x: 200, y: 700 },
          metadata: { label: 'Object Storage DB' },
        },
        {
          id: 'svc-notify',
          config: {
            kind: 'service',
            replicas: 1,
            latencyMs: { type: 'constant', value: 15 },
            failureRate: 0.005,
            maxConcurrency: 100,
          },
          position: { x: 600, y: 700 },
          metadata: { label: 'Notification Service' },
        },
      ],
      edges: [
        { id: 'edge-client-gw', source: 'client-user', target: 'api-gw', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-gw-upload', source: 'api-gw', target: 'svc-upload', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-upload-queue', source: 'svc-upload', target: 'queue-transcode', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-queue-transcode', source: 'queue-transcode', target: 'svc-transcode', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-transcode-storage', source: 'svc-transcode', target: 'db-storage', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-transcode-notify', source: 'svc-transcode', target: 'svc-notify', config: DEFAULT_EDGE_CONFIG },
      ],
    },
    config: {
      seed: 42,
      maxTimeMs: 15000,
      requestRateRps: 80,
      requestDistribution: 'poisson',
    },
  },
  {
    id: 'template-url-shortener',
    name: 'URL Shortener',
    description: 'High-read URL redirect service with cache layer.',
    topology: {
      nodes: [
        {
          id: 'client-user',
          config: { kind: 'client' },
          position: { x: 80, y: 200 },
          metadata: { label: 'Client' },
        },
        {
          id: 'api-gw',
          config: {
            kind: 'api-gateway',
            rateLimitRps: 5000,
            burstSize: 200,
            authLatencyMs: { type: 'constant', value: 1 },
            routes: 4,
            failureRate: 0.001,
            maxConcurrentRequests: 3000,
          },
          position: { x: 280, y: 200 },
          metadata: { label: 'API Gateway' },
        },
        {
          id: 'svc-url',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'constant', value: 12 },
            failureRate: 0.003,
            maxConcurrency: 500,
          },
          position: { x: 480, y: 200 },
          metadata: { label: 'URL Service' },
        },
        {
          id: 'cache-urls',
          config: {
            kind: 'cache',
            evictionPolicy: 'lru',
            maxSizeMb: 1024,
            hitRate: 0.95,
            hitLatencyMs: { type: 'constant', value: 1 },
            missLatencyMs: { type: 'constant', value: 2 },
            ttlMs: 300000,
            maxEntries: 500000,
          },
          position: { x: 680, y: 200 },
          metadata: { label: 'URL Cache' },
        },
        {
          id: 'db-urls',
          config: {
            kind: 'database',
            engine: 'postgres',
            maxConnections: 150,
            queryLatencyMs: { type: 'normal', mean: 4, stddev: 1 },
            writeLatencyMs: { type: 'normal', mean: 8, stddev: 2 },
            failureRate: 0.001,
            connectionPoolSize: 120,
            replicationFactor: 2,
          },
          position: { x: 880, y: 200 },
          metadata: { label: 'URL DB' },
        },
      ],
      edges: [
        { id: 'edge-client-gw', source: 'client-user', target: 'api-gw', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-gw-url', source: 'api-gw', target: 'svc-url', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-url-cache', source: 'svc-url', target: 'cache-urls', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-cache-db', source: 'cache-urls', target: 'db-urls', config: DEFAULT_EDGE_CONFIG },
      ],
    },
    config: {
      seed: 42,
      maxTimeMs: 10000,
      requestRateRps: 2000,
      requestDistribution: 'constant',
    },
  },
  {
    id: 'template-chat-messaging',
    name: 'Chat / Messaging System',
    description: 'Real-time messaging with async delivery and notifications.',
    topology: {
      nodes: [
        {
          id: 'client-user',
          config: { kind: 'client' },
          position: { x: 320, y: 0 },
          metadata: { label: 'User' },
        },
        {
          id: 'api-gw',
          config: {
            kind: 'api-gateway',
            rateLimitRps: 3000,
            burstSize: 100,
            authLatencyMs: { type: 'constant', value: 3 },
            routes: 10,
            failureRate: 0.002,
            maxConcurrentRequests: 2000,
          },
          position: { x: 320, y: 140 },
          metadata: { label: 'API Gateway' },
        },
        {
          id: 'lb-chat',
          config: {
            kind: 'load-balancer',
            algorithm: 'least-connections',
            maxConnections: 5000,
          },
          position: { x: 320, y: 280 },
          metadata: { label: 'Chat LB' },
        },
        {
          id: 'svc-chat',
          config: {
            kind: 'service',
            replicas: 4,
            latencyMs: { type: 'normal', mean: 20, stddev: 5 },
            failureRate: 0.005,
            maxConcurrency: 300,
          },
          position: { x: 320, y: 420 },
          metadata: { label: 'Chat Service' },
        },
        {
          id: 'queue-msg',
          config: {
            kind: 'queue',
            maxDepth: 10000,
            processingTimeMs: { type: 'constant', value: 5 },
            deadLetterEnabled: true,
          },
          position: { x: 320, y: 560 },
          metadata: { label: 'Message Queue' },
        },
        {
          id: 'db-messages',
          config: {
            kind: 'database',
            engine: 'postgres',
            maxConnections: 300,
            queryLatencyMs: { type: 'normal', mean: 5, stddev: 2 },
            writeLatencyMs: { type: 'normal', mean: 10, stddev: 3 },
            failureRate: 0.001,
            connectionPoolSize: 250,
            replicationFactor: 3,
          },
          position: { x: 160, y: 700 },
          metadata: { label: 'Messages DB' },
        },
        {
          id: 'svc-notify',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'constant', value: 10 },
            failureRate: 0.005,
            maxConcurrency: 200,
          },
          position: { x: 480, y: 700 },
          metadata: { label: 'Notification Service' },
        },
      ],
      edges: [
        { id: 'edge-client-gw', source: 'client-user', target: 'api-gw', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-gw-lb', source: 'api-gw', target: 'lb-chat', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-lb-chat', source: 'lb-chat', target: 'svc-chat', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-chat-queue', source: 'svc-chat', target: 'queue-msg', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-queue-db', source: 'queue-msg', target: 'db-messages', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-queue-notify', source: 'queue-msg', target: 'svc-notify', config: DEFAULT_EDGE_CONFIG },
      ],
    },
    config: {
      seed: 42,
      maxTimeMs: 12000,
      requestRateRps: 500,
      requestDistribution: 'poisson',
    },
  },
  {
    id: 'template-rate-limited-api',
    name: 'Rate-Limited API',
    description: 'API with strict rate limiting — observe 429 errors under load.',
    topology: {
      nodes: [
        {
          id: 'client-user',
          config: { kind: 'client' },
          position: { x: 80, y: 200 },
          metadata: { label: 'Client' },
        },
        {
          id: 'api-gw',
          config: {
            kind: 'api-gateway',
            rateLimitRps: 100,
            burstSize: 10,
            authLatencyMs: { type: 'constant', value: 2 },
            routes: 6,
            failureRate: 0.001,
            maxConcurrentRequests: 150,
          },
          position: { x: 280, y: 200 },
          metadata: { label: 'API Gateway' },
        },
        {
          id: 'lb-api',
          config: {
            kind: 'load-balancer',
            algorithm: 'least-connections',
            maxConnections: 2000,
          },
          position: { x: 480, y: 200 },
          metadata: { label: 'API LB' },
        },
        {
          id: 'svc-backend',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'normal', mean: 30, stddev: 8 },
            failureRate: 0.005,
            maxConcurrency: 100,
          },
          position: { x: 680, y: 200 },
          metadata: { label: 'Backend Service' },
        },
        {
          id: 'db-core',
          config: {
            kind: 'database',
            engine: 'postgres',
            maxConnections: 100,
            queryLatencyMs: { type: 'normal', mean: 5, stddev: 2 },
            writeLatencyMs: { type: 'normal', mean: 12, stddev: 4 },
            failureRate: 0.002,
            connectionPoolSize: 80,
            replicationFactor: 2,
          },
          position: { x: 880, y: 200 },
          metadata: { label: 'Core DB' },
        },
      ],
      edges: [
        { id: 'edge-client-gw', source: 'client-user', target: 'api-gw', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-gw-lb', source: 'api-gw', target: 'lb-api', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-lb-backend', source: 'lb-api', target: 'svc-backend', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-backend-db', source: 'svc-backend', target: 'db-core', config: DEFAULT_EDGE_CONFIG },
      ],
    },
    config: {
      seed: 42,
      maxTimeMs: 10000,
      requestRateRps: 500,
      requestDistribution: 'poisson',
    },
  },
  {
    id: 'template-news-feed',
    name: 'News Feed / Timeline',
    description: 'Fan-out read path with feed cache and multiple backend services.',
    topology: {
      nodes: [
        {
          id: 'client-user',
          config: { kind: 'client' },
          position: { x: 320, y: 0 },
          metadata: { label: 'User' },
        },
        {
          id: 'api-gw',
          config: {
            kind: 'api-gateway',
            rateLimitRps: 2000,
            burstSize: 80,
            authLatencyMs: { type: 'constant', value: 2 },
            routes: 15,
            failureRate: 0.001,
            maxConcurrentRequests: 1800,
          },
          position: { x: 320, y: 140 },
          metadata: { label: 'API Gateway' },
        },
        {
          id: 'svc-feed',
          config: {
            kind: 'service',
            replicas: 3,
            latencyMs: { type: 'normal', mean: 25, stddev: 6 },
            failureRate: 0.004,
            maxConcurrency: 250,
          },
          position: { x: 320, y: 280 },
          metadata: { label: 'Feed Service' },
        },
        {
          id: 'cache-feed',
          config: {
            kind: 'cache',
            evictionPolicy: 'lru',
            maxSizeMb: 512,
            hitRate: 0.8,
            hitLatencyMs: { type: 'constant', value: 1 },
            missLatencyMs: { type: 'constant', value: 3 },
            ttlMs: 30000,
            maxEntries: 200000,
          },
          position: { x: 320, y: 420 },
          metadata: { label: 'Feed Cache' },
        },
        {
          id: 'lb-backend',
          config: {
            kind: 'load-balancer',
            algorithm: 'round-robin',
            maxConnections: 3000,
          },
          position: { x: 320, y: 560 },
          metadata: { label: 'Backend LB' },
        },
        {
          id: 'svc-posts',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'normal', mean: 20, stddev: 5 },
            failureRate: 0.003,
            maxConcurrency: 200,
          },
          position: { x: 160, y: 700 },
          metadata: { label: 'Post Service' },
        },
        {
          id: 'svc-users',
          config: {
            kind: 'service',
            replicas: 2,
            latencyMs: { type: 'normal', mean: 15, stddev: 4 },
            failureRate: 0.003,
            maxConcurrency: 200,
          },
          position: { x: 480, y: 700 },
          metadata: { label: 'User Service' },
        },
        {
          id: 'db-core',
          config: {
            kind: 'database',
            engine: 'postgres',
            maxConnections: 200,
            queryLatencyMs: { type: 'normal', mean: 4, stddev: 2 },
            writeLatencyMs: { type: 'normal', mean: 10, stddev: 3 },
            failureRate: 0.001,
            connectionPoolSize: 160,
            replicationFactor: 2,
          },
          position: { x: 320, y: 840 },
          metadata: { label: 'Core DB' },
        },
      ],
      edges: [
        { id: 'edge-client-gw', source: 'client-user', target: 'api-gw', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-gw-feed', source: 'api-gw', target: 'svc-feed', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-feed-cache', source: 'svc-feed', target: 'cache-feed', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-cache-lb', source: 'cache-feed', target: 'lb-backend', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-lb-posts', source: 'lb-backend', target: 'svc-posts', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-lb-users', source: 'lb-backend', target: 'svc-users', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-posts-db', source: 'svc-posts', target: 'db-core', config: DEFAULT_EDGE_CONFIG },
        { id: 'edge-users-db', source: 'svc-users', target: 'db-core', config: DEFAULT_EDGE_CONFIG },
      ],
    },
    config: {
      seed: 42,
      maxTimeMs: 10000,
      requestRateRps: 800,
      requestDistribution: 'constant',
    },
  },
];

export function getTemplateById(id: string): SimforgeTemplate | undefined {
  return builtInTemplates.find((template) => template.id === id);
}
